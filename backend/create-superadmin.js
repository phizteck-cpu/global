import prisma from './prisma/client.js';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Ensure env is loaded properly
if (process.env.NODE_ENV === 'production') {
    dotenv.config({ path: path.resolve(__dirname, '.env.production') });
} else {
    dotenv.config({ path: path.resolve(__dirname, '.env') });
}

// üõ†Ô∏è Auto-fix Hostinger Database Connection if needed
if (process.env.DATABASE_URL && process.env.DATABASE_URL.includes('khaki-termite-134516.hostingersite.com')) {
    console.log('üîÑ Auto-switching DATABASE_URL host to 127.0.0.1 for local execution...');
    process.env.DATABASE_URL = process.env.DATABASE_URL.replace('khaki-termite-134516.hostingersite.com', '127.0.0.1');
}

import bcrypt from 'bcryptjs';

async function createSuperAdmin() {
    console.log('üîó Connecting to database...');

    try {
        const hashedPassword = await bcrypt.hash('superadmin123', 10);
        const superAdminData = {
            email: 'superadmin@valuehills.com',
            username: 'superadmin',
            password: hashedPassword,

            firstName: 'Super',
            lastName: 'Admin',
            role: 'SUPERADMIN',
            status: 'ACTIVE',
            kycStatus: 'VERIFIED',
            emailVerified: true,
            // referralCode will be auto-generated by Prisma default(uuid()) if not provided,
            // or we can explicitly set a static one if desired.
        };

        console.log(`üë§ Creating/Updating Super Admin: ${superAdminData.username}`);

        const user = await prisma.user.upsert({
            where: { email: superAdminData.email },
            update: {
                password: superAdminData.password,
                role: superAdminData.role,
                status: superAdminData.status,
                kycStatus: superAdminData.kycStatus,
                emailVerified: superAdminData.emailVerified
            },
            create: superAdminData,
        });

        console.log('‚úÖ Super Admin created successfully!');
        console.log({
            id: user.id,
            username: user.username,
            email: user.email,
            role: user.role
        });

    } catch (error) {
        console.error('‚ùå Error creating Super Admin:', error);
    } finally {
        await prisma.$disconnect();
    }
}

createSuperAdmin();
