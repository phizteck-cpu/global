generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// -----------------------------------------------------------------------------
// 2. USER ROLES & PERMISSIONS
// -----------------------------------------------------------------------------
model User {
  id             Int     @id @default(autoincrement())
  email          String  @unique
  username       String  @unique
  password       String
  firstName      String
  lastName       String
  phone          String? @unique
  role           String  @default("MEMBER") // MEMBER, ADMIN, SUPERADMIN, ACCOUNTANT
  status         String  @default("ACTIVE") // ACTIVE, SUSPENDED, PENDING_KYC
  transactionPin String? // 4-6 digit encrypted PIN for sensitive operations

  // KYC & Identification
  kycDocUrl String?
  kycStatus String  @default("PENDING") // PENDING, VERIFIED, REJECTED

  // 5. WALLET & LEDGER SYSTEM
  // Separation of balances to represent different ledgers
  walletBalance       Float @default(0.0) // Member Virtual Wallet (Display/Withdrawal)
  contributionBalance Float @default(0.0) // Cooperative Contribution Ledger (Locked)
  bvBalance           Float @default(0.0) // 3.4 BV Accumulation

  // 3.2 Membership & Tier Engine
  tierId Int?
  tier   Tier? @relation(fields: [tierId], references: [id])

  // 3.5 Eligibility & Lock Logic
  joinDate  DateTime  @default(now())
  lockUntil DateTime? // Set to 7 months after registration/completion

  // Referral Tracking
  referralCode String @unique @default(uuid())
  referredBy   Int?

  // Bank Details (for withdrawals)
  bankName      String?
  accountNumber String?
  accountName   String?

  // Relations
  contributions Contribution[]
  transactions  Transaction[]
  auditLogs     AuditLog[]     @relation("AdminAction")
  targetLogs    AuditLog[]     @relation("TargetUser")
  withdrawals   Withdrawal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// 3.2 Membership & Tier Engine
// -----------------------------------------------------------------------------
model Tier {
  id             Int    @id @default(autoincrement())
  name           String @unique // STARTER, PRO, ELITE
  weeklyAmount   Float  @default(1333.33)
  onboardingFee  Float  @default(3000)
  maintenanceFee Float  @default(100)
  upgradeFee     Float  @default(0)

  // 3.2 Rules: Tier controls eligibility ceilings only
  maxWithdrawal Float?
  bvThreshold   Float?

  users     User[]
  createdAt DateTime @default(now())
}

// -----------------------------------------------------------------------------
// 3.3 Contribution Engine
// -----------------------------------------------------------------------------
model Contribution {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  weekNumber  Int // 1 to 45
  amount      Float // Should be 1333.33 for 60k total
  status      String   @default("PAID") // PAID, MISSED
  description String?
  createdAt   DateTime @default(now())
}

// -----------------------------------------------------------------------------
// 5. LEDGER SYSTEM
// -----------------------------------------------------------------------------
model Transaction {
  id     Int   @id @default(autoincrement())
  userId Int
  user   User  @relation(fields: [userId], references: [id])
  amount Float

  // 4. Ledger classification
  ledgerType String // COOPERATIVE, COMPANY, VIRTUAL
  type       String // CONTRIBUTION, ONBOARDING_FEE, MAINTENANCE_FEE, UPGRADE_FEE, WITHDRAWAL_FEE, EARNINGS
  direction  String // IN, OUT

  status      String  @default("SUCCESS") // PENDING, SUCCESS, FAILED
  reference   String? @unique
  description String?

  createdAt DateTime @default(now())
}

// -----------------------------------------------------------------------------
// 3.6 Withdrawal Request Module
// -----------------------------------------------------------------------------
model Withdrawal {
  id     Int    @id @default(autoincrement())
  userId Int
  user   User   @relation(fields: [userId], references: [id])
  amount Float
  status String @default("PENDING") // PENDING, ADMIN_REVIEW, QUEUED, APPROVED, COMPLETED, REJECTED
  fee    Float  @default(0.0)

  adminId     Int?
  processedAt DateTime?
  createdAt   DateTime  @default(now())
}

// -----------------------------------------------------------------------------
// 7. REPORTING & AUDIT
// -----------------------------------------------------------------------------
model AuditLog {
  id           Int      @id @default(autoincrement())
  adminId      Int
  action       String // e.g. "USER_SUSPENSION", "TIER_UPGRADE", "FREEZE"
  targetUserId Int?
  details      String // Reason and context
  ipAddress    String?
  timestamp    DateTime @default(now())

  admin      User  @relation("AdminAction", fields: [adminId], references: [id])
  targetUser User? @relation("TargetUser", fields: [targetUserId], references: [id])
}

model SystemConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}
